name: Node.js CI

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

      - name: Send rich row to Google Sheet
        run: |
          start=$(date +%s)
          npm install
          npm test
          end=$(date +%s)
          build_time=$((end - start))

          # Capture metadata
          node_ver=$(node -v || echo "n/a")
          npm_ver=$(npm -v || echo "n/a")
          short_sha=$(echo "${GITHUB_SHA}" | cut -c1-8)
          branch="${GITHUB_REF_NAME}"
          repo="${GITHUB_REPOSITORY}"
          run_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"tool\":\"GitHub Actions\",\"buildTime\":${build_time},\"testTime\":${build_time},\"status\":\"Success\",\"commit\":\"${short_sha}\",\"branch\":\"${branch}\",\"repo\":\"${repo}\",\"runUrl\":\"${run_url}\",\"runnerType\":\"GitHub-hosted Ubuntu\",\"nodeVersion\":\"${node_ver}\",\"npmVersion\":\"${npm_ver}\",\"toolVersion\":\"Actions\"}" \
            "https://script.google.com/macros/s/AKfycby_efCAW5NnY-XWtykFy6Tj_E43Aor0odrxTzS5_EjW7T-nFv3ts8yDZOJEhtiOI8SC9g/exec"
